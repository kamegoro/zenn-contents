---
title: "jsPDFãƒ»html2canvasã§å‹•çš„ãªãƒ‡ãƒ¼ã‚¿ã®PDFå‡ºåŠ›æ©Ÿèƒ½ã‚’ä½œã£ãŸè©±"
emoji: "ðŸ™†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Svelte", "TypeScript", "jsPDF", "html2canvas"]
published: false
---

## ã¯ã˜ã‚ã«

åˆã‚ã¾ã—ã¦ã€ã‹ã‚ã”ã‚ã¨ç”³ã—ã¾ã™ã€‚
ä»Šæ—¥ã¯ã€æ¥­å‹™ã§ `jsPDF`ãƒ»`html2canvas` ã‚’ç”¨ã„ãŸå‹•çš„ãªãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã® PDF å‡ºåŠ›å®Ÿè£…ã§è‹¦æˆ¦ã—ãŸã®ã§æ€ã„å‡ºã¨ã—ã¦è¨˜äº‹ã‚’æ›¸ã„ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã¯`Svelte.kit` ã§ä½œã‚Šã¾ã—ãŸãŒã€ `React`ã€`Vue` ã‚’è§¦ã£ã¦ã„ã‚‹æ–¹ã§ã‚‚åˆ†ã‹ã‚‹å†…å®¹ã«ãªã£ã¦ã„ã¾ã™ã€‚
ãœã²æœ€å¾Œã¾ã§ãŠä»˜ãåˆã„ãã ã•ã„ã€‚

ä»Šå›žã®ã‚³ãƒ¼ãƒ‰ã®ãƒªãƒã‚¸ãƒˆãƒªã§ã™ã€‚

https://github.com/kamegoro/screen-pdf-output-app

## TL;DR

- ãƒšãƒ¼ã‚¸æ•°ãŒå¤šããªã‚‹å ´åˆã«ã¯å‘ã„ã¦ã„ãªã„ã€‚
- å¤–éƒ¨ã‹ã‚‰èª­ã¿è¾¼ã‚€ç”»åƒã¯å…¨ã¦ã‚’æç”»ã™ã‚‹ã“ã¨ãŒã§ããªã‹ã£ãŸã€‚
- ãƒšãƒ¼ã‚¸æ•°ãŒå¤šããªã‚‹ã¨ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹ã€‚
- ã¾ã ã€æ”¹å–„ã®ä½™åœ°ã¯ã‚ã‚Šãã†ã€‚

## ãªãœ jsPDF ã¨ html2Canvas ã§ã‚„ã£ã¦ã¿ã‚ˆã†ã¨ãªã£ãŸã®ã‹

### html2canvas

https://github.com/niklasvh/html2canvas/

`html2canvas`ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ Element ã‚’ CanvasElement ã«æç”»ã™ã‚‹ã“ã¨ã§ç”»åƒåŒ–ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

æ—¢ã«ã€ç¤¾å†…ã®ä»–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§é‹ç”¨ã•ã‚Œã¦ãŠã‚Šå°Žå…¥ã‚³ã‚¹ãƒˆãŒä½Žã‹ã£ãŸç‚¹ã§æŽ¡ç”¨ã—ã¾ã—ãŸã€‚

### jsPDF

https://github.com/parallax/jsPDF

JavaScript ã§ PDF ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
`jsPDF`ã®ä»–ã«ã€`pdfMake`ã‚„`pdf-lib`ç­‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚‚å¯èƒ½ã§ã™ãŒã€ç›´è¿‘ä¸€å¹´é–“ã®ä½¿ç”¨çŽ‡ã‚„ä»¥å‰ä½¿ç”¨ã—ãŸçµŒé¨“ãŒã‚ã£ãŸç‚¹ã‹ã‚‰æŽ¡ç”¨ã—ã¾ã—ãŸã€‚

![pdf-npm-trend](/images/62fb89f36355fa/pdf-graph.png)

## PDF å‡ºåŠ›ã¾ã§ã®æµã‚Œ

PDF åŒ–ã¾ã§ä¸‹è¨˜ã®æµã‚Œã«ãªã‚Šã¾ã™ã€‚

1. `HTMLElement`ã‚’ `html2canvas` ã§ `CanvasElement` ã«å¤‰æ›
1. `CanvasElement` ã®ç¸¦æ¨ªã®æ¯”çŽ‡ã‚’ç¶­æŒã—ãŸã¾ã¾ PDF ã‚µã‚¤ã‚ºã«å¤‰æ›ã€‚
1. PDF ã®å„ãƒšãƒ¼ã‚¸ã”ã¨ã«æç”»ã§ãã‚‹ç¯„å›²ã®`CanvasElement` ã‚’ç”Ÿæˆã™ã‚‹ã€‚
1. å…¨ã¦ PDF ã«æç”»ã—çµ‚ã‚ã‚‹ã¾ã§ Step3 ã‚’ç¹°ã‚Šè¿”ã™ã€‚

`jsPDF`ã¨`html2canvas`ã®èª¬æ˜Žã¯å‰²æ„›ã•ã›ã¦é ‚ãã¾ã™ã®ã§ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚

#### jsPDF

https://raw.githack.com/MrRio/jsPDF/master/docs/index.html

#### html2canvas

https://html2canvas.hertzen.com/

## å®Ÿè£…è©³ç´°

### 1. `HTMLElement`ã‚’ `html2canvas` ã§ `CanvasElement` ã«å¤‰æ›

ãƒšãƒ¼ã‚¸ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã‚’é–¢æ•°ã«æ¸¡ã—ã¾ã™ã€‚

```ts
import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';

const generatePdf = async (element: HTMLElement) => {
 const doc = new jsPDF('p', 'mm', 'a4', true);

 // A4ã‚µã‚¤ã‚ºã®PDFã®é«˜ã•ãƒ»æ¨ªå¹…
 const pdfWidth = doc.internal.pageSize.getWidth();
 const pdfHeight = doc.internal.pageSize.getHeight();

 // å¼•æ•°ã«æ¸¡ã—ãŸElementãŒCanvasElementã«æç”»ã•ã‚Œã¦è¿”ã•ã‚Œã‚‹
 const canvas = await html2canvas(element);
                       .
                       .
                       .
}
```

### 2. `CanvasElement` ã®ç¸¦æ¨ªã®æ¯”çŽ‡ã‚’ç¶­æŒã—ãŸã¾ã¾ PDF ã‚µã‚¤ã‚ºã«å¤‰æ›

`CanvasElement`ã® PDF ä¸Šã§ã®é«˜ã•ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ã‚’ä½œã‚Šã¾ã™ã€‚

```ts
// ç¸¦æ¨ªã®æ¯”çŽ‡ã‚’ç¶­æŒã—ãŸã¾ã¾PDFã‚µã‚¤ã‚ºã«å¤‰æ›
const convertCanvasHeightForPdf = (
  canvasHeight: number,
  canvasWidth: number,
  pdfContentWidth: number
) => {
  return (canvasHeight * pdfContentWidth) / canvasWidth;
};
```

### 3. PDF ã®å„ãƒšãƒ¼ã‚¸ã”ã¨ã«æç”»ã§ãã‚‹ç¯„å›²ã®`CanvasElement` ã‚’ç”Ÿæˆã™ã‚‹

ä¸€ã¤ã® `CanvasElement` ã®æç”»ç¯„å›²ã‚’æŒ‡å®šã—ã¦ä½¿ã„å›žã™ã“ã¨ã‚‚å‡ºæ¥ã¾ã™ãŒã€ç”Ÿæˆã•ã‚ŒãŸ PDF ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã¨ãƒ¢ãƒƒã‚µãƒªã—ãŸå‹•ãã«ãªã‚Šã¾ã™ã€‚
Adobe Reader ç­‰ã®ãƒ„ãƒ¼ãƒ«ã§é–‹ãã¨åˆ†ã‹ã‚Šã¾ã™ãŒã€è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„éƒ¨åˆ†ã«ã‚‚ç”»åƒãŒå­˜åœ¨ã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

| æ‚ªã„ä¾‹                                     | è‰¯ã„ä¾‹                                       |
| ------------------------------------------ | -------------------------------------------- |
| ![bad](/images/62fb89f36355fa/pdf-bad.png) | ![good](/images/62fb89f36355fa/pdf-good.png) |

ãƒšãƒ¼ã‚¸ã‚’è·¨ãéš›ã«è‰¯ã—ãªã«ç”»åƒã‚’åˆ‡ã‚Šåˆ†ã‘ã¦ã¯è²°ãˆãªã„ã®ã§ã€ä»Šå›žã¯ `CanvasElement` ã‚’å…ƒã«ãƒšãƒ¼ã‚¸æ¯Žã«æ–°ã—ã„ `CanvasElement` ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ã‚’ä½œã‚Šã¾ã™ã€‚

```ts
const clipCanvas = (
  baseCanvas: HTMLCanvasElement,
  canvasPdfY: number,
  pdfWidth: number,
  clipPdfHeight: number
) => {
  const clipCanvas = document.createElement("canvas");

  // PDFã®é«˜ã•ã‹ã‚‰Canvasã®é«˜ã•ã‚’é€†ç®—
  const clipCanvasHeight = (pdfHeight: number) =>
    (pdfHeight * baseCanvas.width) / pdfWidth;

  clipCanvas.width = baseCanvas.width;
  clipCanvas.height = clipCanvasHeight(clipPdfHeight);
  const context = clipCanvas.getContext("2d");
  if (context) {
    context.drawImage(baseCanvas, 0, clipCanvasHeight(canvasPdfY));
  }

  return {
    height: clipCanvas.height,
    width: clipCanvas.width,
    dataUrl: clipCanvas.toDataURL("image/png"),
  };
};
```

### 4. å…¨ã¦ PDF ã«æç”»ã—çµ‚ã‚ã‚‹ã¾ã§ Step3 ã‚’ç¹°ã‚Šè¿”ã™

Step2 ã§è¨ˆç®—ã•ã‚ŒãŸ PDF ä¸Šã§ã® `CanvasElement` ã®åˆ†ã€æç”»ã•ã‚Œã‚‹ã¾ã§ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚

```md
1. ï¼‘ãƒšãƒ¼ã‚¸åˆ† PDF ã®é«˜ã•ã® `CanvasElement` ã®ç”Ÿæˆ
2. PDF ã«æç”»
3. ãƒ™ãƒ¼ã‚¹ã® Canvas ã‹ã‚‰ï¼‘ãƒšãƒ¼ã‚¸åˆ† PDF ã®é«˜ã•ã‚’å¼•ã
4. ãƒ™ãƒ¼ã‚¹ã® Canvas ã®é«˜ã•ãŒ 0 ã‚ˆã‚Šå°ã•ããªã‚‹ã¾ã§ 1 ~ 3 ã‚’ç¹°ã‚Šè¿”ã™
```

```ts
const heightInCanvasPdf = convertCanvasHeightForPdf(
  canvas.height,
  canvas.width,
  pdfContentWidth
);
let restImageHeight = heightInCanvasPdf;

while (restImageHeight > 0) {
  if (restImageHeight <= pdfHeight) {
    const clippedCanvas = clipCanvas(
      canvas,
      -(heightInCanvasPdf - restImageHeight),
      pdfContentWidth,
      restImageHeight
    );
    doc.addImage(clippedCanvas.dataUrl, "PNG", margin, 0, pdfContentWidth, 0);
    restImageHeight -= pdfHeight;
  } else {
    const clippedCanvas = clipCanvas(
      canvas,
      -(heightInCanvasPdf - restImageHeight),
      pdfContentWidth,
      pdfHeight
    );
    doc.addImage(clippedCanvas.dataUrl, "PNG", margin, 0, pdfContentWidth, 0);
    doc.addPage();
    restImageHeight -= pdfHeight;
  }
}
```

## ã¾ã¨ã‚

`html2canvas`ã‚’ç”¨ã„ãŸå‹•çš„ãª PDF å‡ºåŠ›ã®ä¾‹ãŒã‚ã¾ã‚Šè¦‹ã¤ã‹ã‚‰ãªãã€æ‰‹æŽ¢ã‚Šã§é€²ã‚ã¦ã„ãŸãŸã‚ãƒã‚°ã«å½“ãŸã£ã¦ã¯ä¿®æ­£ã‚’ç¹°ã‚Šè¿”ã—ã¦ã„ã¾ã—ãŸã€‚

åˆæœŸå®Ÿè£…æ™‚ã¯ã€ãƒšãƒ¼ã‚¸æ¯Žã«ç”»åƒã‚’åˆ‡ã‚Šåˆ†ã‘ãšã«ä¸€ã¤ã®ç”»åƒã®è¡¨ç¤ºé ˜åŸŸã‚’èª¿æ•´ã—ã¦å®Ÿè£…ã—ã¾ã—ãŸãŒ Adobe Reader ã‚’ä½¿ã£ã¦ãªã‹ã£ãŸã®ã§åŽŸå› ã‚’æŽ´ã‚€ã®ã«æ™‚é–“ãŒã‹ã‹ã£ãŸã‚Šã¨ã€ç·åˆçš„ãªæ™‚é–“ã‚’è€ƒãˆã‚‹ã¨ã€ã‚µãƒ¼ãƒãƒ¼å´ã§è¦ç´ ã‚’çµ„ã¿ç«‹ã¦ã‚‹æ–¹ãŒæ—©ã‹ã£ãŸãªãã¨æ€ã£ãŸã‚Š..

ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒªã®å®Ÿè£…ã¯`faker.js`ã‚’ä½¿ã£ã¦å¤–éƒ¨ã‹ã‚‰ç”»åƒã‚’å–å¾—ã—ã¦ã„ã¾ã—ãŸãŒã€PDF åŒ–æ™‚ã«ç”»åƒãŒè¡¨ç¤ºãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œãªã„ã®ã‚’è§£æ¶ˆã§ããªã‹ã£ãŸã®ã§æ–­å¿µã—ã¾ã—ãŸãŒã€ä»–ã«ã„ãã¤ã‹åŒæ§˜ãªå•é¡Œã‚’æŒ™ã’ã¦ã‚‹ issue ã‚’è¦‹ã‹ã‘ã¾ã—ãŸã€‚

https://github.com/parallax/jsPDF/issues/1578

ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æ”¹å–„æ¬¡ç¬¬ã§ã¯å¤‰ã‚ã‚‹ã‹ã‚‚ã§ã™ãŒã€7ã€8 ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã§ç”Ÿæˆã« 10 ç§’å‰å¾Œã‹ã‹ã‚‹ã ã‘ã§ãªãã€10 ãƒšãƒ¼ã‚¸ã‚’è¶…ãˆã‚‹ã¨ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—å‡ºã™ã®ã§çµæžœçš„ã«ã¯å‹•çš„ãªãƒšãƒ¼ã‚¸ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ¬¡ç¬¬ã§ãƒšãƒ¼ã‚¸æ•°ãŒå¤šããªã‚Šå¾—ã‚‹å ´åˆï¼‰ã® PDF åŒ–ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®ç”Ÿæˆã¯å‘ã„ã¦ãªã„ãªã€‚ã¨æ„Ÿã˜ã¾ã—ãŸã€‚

ã¨ã¯ã„ãˆã€ç†è§£ãŒã‚ã‚Œã°ç°¡å˜ã«å®Ÿè£…ã™ã‚‹äº‹ãŒã§ãã‚‹ã®ã§è¦ä»¶ã«ã‚ˆã£ã¦ã¯ä»Šå¾Œã‚‚ä½¿ã†æ©Ÿä¼šã¯ã‚ã‚Šãã†ã§ã™ã€‚
